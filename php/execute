#!/usr/bin/env php
<?php

require_once __DIR__ . '/helpers/curl.php';

function buildItem(array $row, array $headers): array
{
    return array_combine($headers, [
        floatval($row[0]),
        floatval($row[1]),
        floatval($row[2]),
        floatval($row[3]),
        $row[4],
    ]);
}

function sendInTheScouts($file): array
{
    return fgetcsv($file);
}

function sendInTheSkirmishers($file): void
{
    for ($i = 1; $i < 200; $i++) fgetcsv($file);
}

function sendInTheFootSoldiers($file, $headers): void
{
    for ($j = 200; $j < 300; $j++) {
        $row = fgetcsv($file);

        $item = buildItem($row, $headers);

        curlPost("http://localhost:80/receive_features.php", $item);
    }
}

function sendInTheCavalry($file, $headers): void
{
    while ($row = fgetcsv($file)) {
        $item = buildItem($row, $headers);

        curlPost("http://localhost:80/receive_features.php", $item);

        sleep(1);
    }
}

function readCSV(): void
{
    $file = fopen("dummy.csv", 'r');

    $headers = sendInTheScouts($file);
    sendInTheSkirmishers($file);
    sendInTheFootSoldiers($file, $headers);
    sendInTheCavalry($file, $headers);

    fclose($file);
}

while (true) {
    curlPost("http://localhost:80/truncate_points.php", []);

    sleep(5);

    readCSV();

    sleep(5);
}